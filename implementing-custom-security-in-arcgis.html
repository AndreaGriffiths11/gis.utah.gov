<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Implementing custom security in ArcGIS</title>
  <meta name="description" content="Securing ArcGIS services is often an after thought. I can speak from experience when saying that unchecking the box to 'Enable Web Access' on a map service w...">

  <link rel="stylesheet" href="/website/css/main.css">
  <link rel="canonical" href="agrc.github.io/website/implementing-custom-security-in-arcgis">
  <link rel="alternate" type="application/rss+xml" title="Utah Mapping Portal" href="agrc.github.io/website/feed.xml" />
</head>


  <body>

    <header id="header">
  <div class="inner">
    <div id="logo">
      <a href="agrc.github.io">
        <img class="ie_png" src="/website/images/agrc_logo.png" alt="Utah Mapping Portal" />
      </a>
    </div>
    <div id="top_area">
    </div>
    <nav id="navigation">
      <ul id="menu-main-menu" class="menu">
        <li class="menu-item"><a href="/website/agrc-newsletter">News</a>
        </li>
        <li class="menu-item"><a href="/website/data">Data</a>
        </li>
        <li class="menu-item"><a href="/website/developer">Developer</a>
        </li>
        <li class="menu-item"><a href="/website/about">About</a>
        </li>
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Implementing custom security in ArcGIS</h1>
  </header>

  <article class="post-content">
    <p>Securing ArcGIS services is often an after thought. I can speak from experience when saying that unchecking the box to 'Enable Web Access' on a map service was thought to be enough smoke and mirrors to secure a service behind a login screen. After all, if a person can't see the service in the REST services directory or when connected to the server via ArcCatalog, then that service must be secure. </p>
<p>ArcGIS Server, by design, is multitenanted in the sense that one server is handling requests for many different applications and users. All of these applications have separate requirements and user bases and this is where the default install of ArcGIS Server breaks down.</p>
<p>By default ArcGIS Server does not enable security. Retrofitting security is a bit of a pain because you need to schedule down time; When you enable security, all of your services become unreachable. To re-allow access to them you need to add the 'Everyone' role to the allowed roles for all services. This gives the services the same functional state as before security was enabled.</p>
<p>ArcGIS Server allows you to use the same ASP.NET membership and role provider for the default instance - ArcGIS. I'm going to exclude any authentication that is not database driven in this article. This setting is great if you have the same user base for all of the applications using ArcGIS Server, but how realistic is that?</p>
<p>In our agency, we create applications for other agencies, for the public, and for ourselves. The applications built for other agencies usually have unique sets of users. Since we are using the same ArcGIS Server for all of these applications, we needed a solution for securing these applications against unique databases.</p>
<p>To accomplish this we have to run multiple instances of ArcGIS Server. When I say that, I mean we use the utility which can be found at [code]C:\Program Files (x86)\ArcGIS\DotNet\AddInstance.exe for 9.3<br />
or<br />
C:\Program Files (x86)\ArcGIS\Server10.0\DotNet\AddInstance.exe for version 10[/code] to create separate virtual directories in IIS for handling requests. Our convention is to use ArcGIS_%ApplicationName% to keep things organized.</p>
<p>Assuming that security is enabled and the token service is also enabled for ArcGIS Server, we then have to dive into XML web.config editing. The four web.config files we modify are inside the ArcGIS_%ApplicationName% folder in IIS. These paths are </p>
<p>[code]rest/web.config<br />
Security/web.config<br />
Services/web.config<br />
Tokens/web.config[/code]</p>
<p>Inside all of these web config files we have to add our connection string to the database that holds our users credentials in the standard manor. </p>
<p>[code]<configuration><br />
    <connectionStrings><br />
        <add connectionString="" name="CustomConnectionStringName" /><br />
    </connectionStrings><br />
    ...<br />
</configuration>[/code]</p>
<p>Starting with the rest web.config, I will usually update the [code]<appSettings>[/code] key for TokenServiceURL since that can point to a machine name instead of a domain name.  If you are not using SSL, then you will also need to add the key [code]<add key="RequireSSL" value="False" />[/code] to [code]<appSettings>[/code] </p>
<p>From my reverse engineering efforts, I've noticed that the rest service only makes use of a Role Provider. It also only invokes the Initialize and GetRolesForUser methods on the role provider. Add the ASP.NET role manager in the standard manor.</p>
<p>[code]<system.web><br />
    <roleManager enabled="true" defaultProvider="CustomRoleProvider"></p>
<providers>
        <clear /><br />
        <add connectionStringName="CustomConnectionStringName" applicationName="/"<br />
          name="CustomRoleProvider" type="Custom DLL QualifiedName, Custom DLL Namespace" />
      </providers>
    </roleManager><br />
    ...<br />
</system.web><br />
[/code]<br />
If you are using a database registered to be a ASP.NET Membership database, you can use the default System.Web.Security.SqlRoleProvider provider. You will additionally need to set the applicationName so it finds the right users. </p>
<p>If you are using a custom provider you can register it in the GAC or place the .dll's in a bin directory inside the token folder and the dll's will be discovered. </p>
<p>[code]/rest/bin/customProvider.dll[/code]</p>
<p>The Security virtual directory is used by ArcGIS Server Manager. It allows you to add your roles to your services. It only uses a role provider so you can mimic the settings on the rest web.config file. You only need to implement the GetAllRoles method on the role provider. Additionally, you need to change the authentication mode to 'Forms'.</p>
<p>[code]<system.web><br />
    <authentication mode="Forms"></p>
<forms loginUrl="login.aspx" path="/" />
    </authentication><br />
    ...<br />
</system.web>[/code]</p>
<p>Moving on to the Services web.config file. This virtual directory handles SOAP requests. You can ignore modifying this file if you aren't using SOAP. We don't use it so I'm not sure what providers it needs.  But to be safe, add your role provider and membership provider. We also lower the [code]<appSettings>[/code] key GCInterval to 750 and update the TokenServiceURL.</p>
<p>Finally, we have to modify the Token services web.config. The token service requires only a membership provider and it invokes the Initialize and ValidateUser methods. We modify the [code]<appSettings>[/code] keys TokenServiceURL and RequireSSL and we add our membership provider in the standard ASP.NET fashion.</p>
<p>[code]<system.web><br />
<membership defaultProvider="CustomMembershipProvider"></p>
<providers>
    <clear /><br />
    <add connectionStringName="CustomConnectionStringname" enablePasswordRetrieval="false"<br />
      enablePasswordReset="false" requiresQuestionAndAnswer="false"<br />
      applicationName="/" requiresUniqueEmail="false" passwordFormat="Clear"<br />
      maxInvalidPasswordAttempts="20" minRequiredPasswordLength="7"<br />
      minRequiredNonalphanumericCharacters="1" passwordAttemptWindow="10"<br />
      passwordStrengthRegularExpression="" name="CustomMembershipProvider"<br />
      type="Custom DLL QualifiedName, Custom DLL Namespace" />
  </providers>
</membership><br />
...<br />
</system.web>[/code]</p>
<p>Once again, you can register your dll with the GAC or place the files in </p>
<p>[code]/Tokens/bin/customProvider.dll[/code]</p>
<p>After going through all of these steps, open ArcGIS Manager and navigate to your services. Then click on the lock icon and add the roles you want to grant access to.</p>
<p>To test your service try out this simple script.</p>
<p><script src="https://gist.github.com/3230058.js"> </script></p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Utah Mapping Portal</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Utah Mapping Portal</li>
          <li><a href="mailto:agrc@utah.gov">agrc@utah.gov</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/agrc">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">agrc</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/MapUtah">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">MapUtah</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Utah Mapping Portal | The Utah Automated Geographic Reference Center</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
